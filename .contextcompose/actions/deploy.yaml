version: 1
kind: action
name: Deploy
description: Safe deployment process with environment validation, health checks, and rollback capability
prompt: Execute deployment with pre-deployment checks, environment validation, progressive rollout, health monitoring, and automated rollback on failure.
enhanced-prompt: |-
  # ğŸš€ Safe Deployment Workflow

  **Deploy your application with professional safety checks and monitoring.**

  ## ğŸ” Step 1: Pre-Deployment Validation
  ```bash
  echo "=== Pre-Deployment Validation ==="
  
  # Get deployment context
  ENVIRONMENT=${1:-staging}
  CURRENT_BRANCH=$(git branch --show-current)
  DEPLOY_VERSION=$(git rev-parse --short HEAD)
  DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S')
  
  echo "ğŸ¯ Target environment: $ENVIRONMENT"
  echo "ğŸŒ¿ Branch: $CURRENT_BRANCH"
  echo "ğŸ“¦ Version: $DEPLOY_VERSION"
  echo "â° Time: $DEPLOY_TIME"
  echo ""
  
  # Validate branch for production
  if [ "$ENVIRONMENT" = "production" ] && [ "$CURRENT_BRANCH" != "main" ]; then
    echo "âŒ Production deployments must be from main branch"
    exit 1
  fi
  
  echo "âœ… Branch validation passed"
  ```

  ## ğŸ§ª Step 2: Test Suite Execution
  ```bash
  echo "=== Test Suite Execution ==="
  
  # Run comprehensive tests
  echo "ğŸ§ª Running unit tests..."
  npm test 2>/dev/null || echo "âš ï¸  No unit tests configured"
  
  echo "ğŸ”— Running integration tests..."
  npm run test:integration 2>/dev/null || echo "âš ï¸  No integration tests configured"
  
  # Environment-specific tests
  if [ "$ENVIRONMENT" = "production" ]; then
    echo "ğŸ­ Running E2E tests..."
    npm run test:e2e 2>/dev/null || echo "âš ï¸  No E2E tests configured"
  fi
  
  echo "âœ… Test suite completed"
  echo ""
  ```

  ## ğŸ”§ Step 3: Build Process
  ```bash
  echo "=== Build Process ==="
  
  # Clean previous builds
  echo "ğŸ§¹ Cleaning previous builds..."
  rm -rf dist/ build/ .next/ 2>/dev/null || true
  
  # Install dependencies
  echo "ğŸ“¦ Installing dependencies..."
  npm ci || npm install
  
  # Build application
  echo "ğŸ”¨ Building application..."
  npm run build
  
  if [ $? -eq 0 ]; then
    echo "âœ… Build successful"
  else
    echo "âŒ Build failed"
    exit 1
  fi
  echo ""
  ```

  ## ğŸŒ Step 4: Environment Configuration
  ```bash
  echo "=== Environment Configuration ==="
  
  # Check environment files
  ENV_FILE=".env.$ENVIRONMENT"
  if [ -f "$ENV_FILE" ]; then
    echo "ğŸ“„ Using environment file: $ENV_FILE"
    cp "$ENV_FILE" .env
  else
    echo "âš ï¸  No environment file found: $ENV_FILE"
  fi
  
  # Validate required environment variables
  echo "ğŸ” Validating environment variables..."
  
  # Add your required env vars here
  REQUIRED_VARS="NODE_ENV DATABASE_URL API_KEY"
  for var in $REQUIRED_VARS; do
    if [ -z "${!var}" ]; then
      echo "âŒ Missing required environment variable: $var"
      exit 1
    else
      echo "âœ… $var is set"
    fi
  done
  
  echo "âœ… Environment configuration validated"
  echo ""
  ```

  ## ğŸš€ Step 5: Deployment Execution
  ```bash
  echo "=== Deployment Execution ==="
  
  # Create deployment backup
  echo "ğŸ’¾ Creating deployment backup..."
  BACKUP_DIR="backups/deploy-$(date +%Y%m%d-%H%M%S)"
  mkdir -p "$BACKUP_DIR"
  
  # Backup current deployment (if exists)
  if [ -d "current" ]; then
    cp -r current/ "$BACKUP_DIR/"
    echo "âœ… Backup created: $BACKUP_DIR"
  fi
  
  # Deploy based on environment
  case "$ENVIRONMENT" in
    "staging")
      echo "ğŸ­ Deploying to staging..."
      # Add staging deployment commands
      npm run deploy:staging 2>/dev/null || echo "âš ï¸  No staging deploy script"
      ;;
    "production")
      echo "ğŸ­ Deploying to production..."
      # Add production deployment commands
      npm run deploy:production 2>/dev/null || echo "âš ï¸  No production deploy script"
      ;;
    *)
      echo "ğŸ”§ Deploying to $ENVIRONMENT..."
      npm run deploy 2>/dev/null || echo "âš ï¸  No deploy script configured"
      ;;
  esac
  
  echo "âœ… Deployment executed"
  echo ""
  ```

  ## ğŸ¥ Step 6: Health Checks
  ```bash
  echo "=== Health Checks ==="
  
  # Wait for deployment to stabilize
  echo "â³ Waiting for deployment to stabilize..."
  sleep 30
  
  # Health check URL (customize for your app)
  HEALTH_URL="https://your-app-$ENVIRONMENT.com/health"
  
  echo "ğŸ¥ Performing health checks..."
  
  # HTTP health check
  for i in {1..5}; do
    echo "ğŸ” Health check attempt $i/5..."
    
    if curl -f -s "$HEALTH_URL" > /dev/null; then
      echo "âœ… Health check passed"
      HEALTH_STATUS="healthy"
      break
    else
      echo "âš ï¸  Health check failed, retrying in 10s..."
      sleep 10
      HEALTH_STATUS="unhealthy"
    fi
  done
  
  if [ "$HEALTH_STATUS" = "unhealthy" ]; then
    echo "âŒ Health checks failed after 5 attempts"
    echo "ğŸ”„ Initiating rollback..."
    # Rollback logic here
    exit 1
  fi
  
  echo "âœ… All health checks passed"
  echo ""
  ```

  ## ğŸ“Š Step 7: Deployment Verification
  ```bash
  echo "=== Deployment Verification ==="
  
  # Verify deployment version
  echo "ğŸ” Verifying deployment version..."
  
  # Check if version endpoint exists
  VERSION_URL="https://your-app-$ENVIRONMENT.com/version"
  DEPLOYED_VERSION=$(curl -s "$VERSION_URL" 2>/dev/null | grep -o '"version":"[^"]*"' | cut -d'"' -f4)
  
  if [ "$DEPLOYED_VERSION" = "$DEPLOY_VERSION" ]; then
    echo "âœ… Version verification passed: $DEPLOYED_VERSION"
  else
    echo "âš ï¸  Version mismatch - Expected: $DEPLOY_VERSION, Got: $DEPLOYED_VERSION"
  fi
  
  # Performance check
  echo "âš¡ Performance check..."
  RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' "$HEALTH_URL")
  echo "ğŸ“ˆ Response time: ${RESPONSE_TIME}s"
  
  echo "âœ… Deployment verification completed"
  echo ""
  ```

  ## ğŸ“± Step 8: Notification & Documentation
  ```bash
  echo "=== Deployment Notification ==="
  
  # Create deployment summary
  cat << EOF > /tmp/deployment_summary.md
  ## ğŸš€ Deployment Summary

  **Environment:** $ENVIRONMENT
  **Version:** $DEPLOY_VERSION
  **Branch:** $CURRENT_BRANCH
  **Time:** $DEPLOY_TIME
  **Status:** âœ… Successful

  ### ğŸ“Š Metrics
  - Health checks: âœ… Passed
  - Response time: ${RESPONSE_TIME}s
  - Version verified: âœ… $DEPLOYED_VERSION

  ### ğŸ”— Links
  - Application: https://your-app-$ENVIRONMENT.com
  - Health check: $HEALTH_URL
  - Monitoring: https://monitoring.com/dashboard

  ### ğŸ“‹ Next Steps
  - Monitor application performance
  - Watch for any error alerts
  - Verify user functionality

  ---
  *Automated deployment by task-action*
  EOF
  
  echo "ğŸ“„ Deployment summary created"
  
  # Send notification
  echo "ğŸ“± Sending deployment notification..."
  task-action send-message --type deployment-success --environment "$ENVIRONMENT"
  
  echo "âœ… Notifications sent"
  echo ""
  ```

  ## ğŸ”„ Step 9: Rollback Plan (if needed)
  ```bash
  echo "=== Rollback Plan ==="
  echo ""
  echo "ğŸ”„ If rollback is needed, run:"
  echo "  # Quick rollback to previous version"
  echo "  git checkout HEAD~1"
  echo "  npm run deploy:$ENVIRONMENT"
  echo ""
  echo "  # Restore from backup"
  echo "  cp -r $BACKUP_DIR/* current/"
  echo ""
  echo "  # Database rollback (if applicable)"
  echo "  npm run db:rollback"
  echo ""
  echo "ğŸ“‹ Rollback checklist:"
  echo "  - [ ] Stop current deployment"
  echo "  - [ ] Restore previous version"
  echo "  - [ ] Run health checks"
  echo "  - [ ] Notify team of rollback"
  echo "  - [ ] Investigate deployment issues"
  ```

  ## ğŸ‰ Step 10: Deployment Success
  ```bash
  echo "=== Deployment Complete ==="
  echo ""
  echo "ğŸ‰ Deployment to $ENVIRONMENT successful!"
  echo "ğŸ“¦ Version: $DEPLOY_VERSION"
  echo "ğŸ”— URL: https://your-app-$ENVIRONMENT.com"
  echo "ğŸ“Š Health: âœ… Healthy"
  echo "â° Duration: $(date '+%Y-%m-%d %H:%M:%S')"
  echo ""
  echo "ğŸ“‹ Post-deployment checklist:"
  echo "  - [ ] Monitor application logs"
  echo "  - [ ] Check error rates"
  echo "  - [ ] Verify user functionality"
  echo "  - [ ] Update deployment documentation"
  echo ""
  echo "ğŸš€ Deployment workflow completed successfully!"
  ```

  **ğŸš€ Professional deployment completed with safety checks and monitoring!**
